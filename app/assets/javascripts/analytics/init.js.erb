(function() {
  "use strict";

  var consentCookie = window.GOVUK.getConsentCookie();

  var dummyAnalytics = {
    addLinkedTrackerDomain: function(){},
    setDimension: function(){},
    setOptionsForNextPageView: function(){},
    trackEvent: function(){},
    trackPageview: function(){},
    trackShare: function(){},
  };

  // Disable analytics by default
  // This will be reversed below, if the consent cookie says usage cookies are allowed
  window['ga-disable-UA-26179049-1'] = true;

  if (!consentCookie || consentCookie["usage"]) {
    window['ga-disable-UA-26179049-1'] = false;

    // Load Google Analytics libraries
    GOVUK.StaticAnalytics.load();

    // Use document.domain in dev, preview and staging so that tracking works
    // Otherwise explicitly set the domain as www.gov.uk (and not gov.uk).
    var cookieDomain = (document.domain == 'www.gov.uk') ? '.www.gov.uk' : document.domain;

    var universalId = '<%= Rails.application.config.ga_universal_id %>';
    var secondaryId = '<%= Rails.application.config.ga_secondary_id %>';

    // Configure profiles, setup custom vars, track initial pageview
    var analytics = new GOVUK.StaticAnalytics({
      universalId: universalId,
      cookieDomain: cookieDomain,
      allowLinker: true,
      // This is served by Fastly in production, and returns an empty 200 response
      govukTrackerUrl: '<%= asset_path "/static/a" %>'
    });

    // Make interface public for virtual pageviews and events
    GOVUK.analytics = analytics;

    var linkedDomains = [
      'access.service.gov.uk',
      'apply-for-eu-settled-status.homeoffice.gov.uk',
      'apply-for-innovation-funding.service.gov.uk',
      'apply-quota.fluorinated-gas.service.gov.uk',
      'apply-quota.ozone-depleting-substances.service.gov.uk',
      'design-system.service.gov.uk',
      'gro.gov.uk',
      'import-products-animals-food-feed.service.gov.uk',
      'makeaplea.service.gov.uk',
      'manage-fish-exports.service.gov.uk',
      'manage-quota.fluorinated-gas.service.gov.uk',
      'passport.service.gov.uk',
      'paydvlafine.service.gov.uk',
      'register.fluorinated-gas.service.gov.uk',
      'register.ozone-depleting-substances.service.gov.uk',
      'report.fluorinated-gas.service.gov.uk',
      'report.ozone-depleting-substances.service.gov.uk',
      'tax.service.gov.uk',
      'vehicle-operator-licensing.service.gov.uk'
    ];
    GOVUK.analytics.addLinkedTrackerDomain(secondaryId, 'govuk', linkedDomains);
  } else {
    GOVUK.analytics = dummyAnalytics
  }
})();
